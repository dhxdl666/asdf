name: Get Grafana Dashboard Json File

on:
  workflow_dispatch:
    # Inputs the workflow accepts.
    inputs:
      matrixone-branch_or_commitID:
          description: 'matrixone-branch_or_commitID'
          default: 'main'
          required: true
          type: string
      # matrixone-commit_ID:
      #     description: 'matrixone-commit_ID'
      #     default: ''
      #     required: false
      #     type: string
      gitops-branch:
          description: 'gitops-branch'
          default: 'main'
          required: true
          type: string
      directory:
          description: 'directory'
          default: 'test'
          required: true
          type: string


jobs:
  Get-Json-File:
    runs-on: ubuntu-latest
    steps:
    - name: checkout repository
      uses: actions/checkout@v4
      with:
        repository: lcxznpy/matrixone
        ref: ${{ inputs.matrixone-branch_or_commitID }}
        fetch-depth: 0
    - name: Use Golang
      uses: actions/setup-go@v4
      with:
        go-version: "1.20.11"
        cache: false
    - name: Deploy Grafana
      run: |
        docker pull grafana/grafana
        docker run -d -p 80:3000 --name=grafana grafana/grafana
    - name: Upload Dashboard configuration
      run: |
        docker ps -a 
        ls
        pwd
        cd ./pkg/util/metric/v2/dashboard
        go test
    - name: Save file
      run: |
        cd $GITHUB_WORKSPACE
        mkdir dashboard
        # uid_array=($(curl http://admin:admin@localhost:80/api/search\?type\=dash-db | jq -r '.[].uid'))
        # echo $uid_array
        curl -s "http://admin:admin@localhost:80/api/search" | jq -r > data.json
        count=$(jq '. | length' data.json)
        echo $count

        for ((i=0;i < count;i++));do
                uid=$(jq --arg i $i '.[$i|tonumber].uid' data.json)
                uid=${uid//\"}
                 ##echo $uid
                title=$(jq --arg i $i '.[$i|tonumber].title' data.json)
                title=${title//\"}
                 ##echo $title
                 title=${title// /_}
                 ##echo $title
                curl -s "http://admin:admin@localhost:80/api/dashboards/uid/$uid" | jq .dashboard  > "/root/test/dashboard/$title.json"
        done

        # for element in "${uid_array[@]}"; do
        #     # echo "$element"
        #     curl -s "http://admin:admin@localhost:80/api/dashboards/uid/$element" | jq .dashboard > $GITHUB_WORKSPACE/dashboard/$element.json
        # done
        ls -la $GITHUB_WORKSPACE/dashboard
    - name: upload json artifacts
      uses: actions/upload-artifact@v3
      with:
        name: dashboard
        path: |
          ./dashboard/*
  Create-branch:
    needs: Get-Json-File
    runs-on: ubuntu-latest
    steps:
    - name: checkout repository
      uses: actions/checkout@v4
      with: 
        fetch-depth: 0
    - name: create branch 
      uses: peterjgrainger/action-create-branch@v2.2.0
      env:
        GITHUB_TOKEN: ${{ secrets.TOKEN_ACTION }}
      with:
        branch: ${{ inputs.gitops-branch}}
        sha: '${{ github.event.pull_request.head.sha }}'
    - name: change branch 
      run: |
        git config --global user.name "github-action-robot"
        git config --global user.email "github-action-robot@github.com"
        git branch -vv
        git fetch
        git checkout ${{ inputs.gitops-branch}}
        git branch -vv
    - name: Download Json
      uses: actions/download-artifact@v3
      with:
        path: dashboard
        name: dashboard
    - name: ls dashboard file
      run: |
        git branch -vv
        ls -la
        ls -la ./dashboard
        pwd
        ls -la ./dashboard
        # tail 10 ./dashboard/*
    - name: checkout folder exist
      run: |
        ls -la
        rm -rf ${{ inputs.directory }}
        mkdir -p ${{ inputs.directory }}
        ls && pwd 
        mv ./dashboard/* $GITHUB_WORKSPACE/${{ inputs.directory }}/
        cd $GITHUB_WORKSPACE/${{ inputs.directory }}
        ls && pwd
        cd $GITHUB_WORKSPACE
        ls && pwd
        git add .
        git commit -m "update dashboard"
        # git push origin ${{ inputs.gitops-branch}}
        git branch -vv
    - name: Create Pull Request
      uses: peter-evans/create-pull-request@v5
      with:
          token: ${{ secrets.TOKEN_ACTION }}
          commit-message: Update dependencies
          base: main
          branch: ${{ inputs.gitops-branch}}
          delete-branch: true
  # Create-PR:
  #   needs: Push
  #   runs-on: ubuntu-latest
  #   steps:
  #   - name: checkout repository
  #     uses: actions/checkout@v4
  #   - name: Create Pull Request
  #     uses: peter-evans/create-pull-request@v5
  #     with:
  #         token: ${{ secrets.TOKEN_ACTION }}
  #         commit-message: Update dependencies
  #         base: main
  #         branch: ${{ inputs.gitops-branch}}
    
  # matrixone-commit_ID:
  #         description: 'matrixone-commit_ID'
  #         default: ''
  #         required: true
  #         type: string
